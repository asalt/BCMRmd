---
title: "tackle"
author: "AlexSaltman"
date: "`r Sys.Date()`"
output: html_document
params:
  cluster_methods:
    value: [kmeans, pam]
  cluster:
    value:
      cluster_rows:
        value: true
        description: "cluster the rows"
      cluster_columns:
        value: true
      cluster_row_slices:
        value: true
      cluster_col_slices:
        value: true
      clustering_distance_rows:
        value: euclidean
      clustering_method_rows:
        value: ward.d2
      legend_include:
        value: 
        description: "metadata variables to include"
      legend_exclude:
        value:
        description: "metadata variables to exclude"
---

```{r tackle.setup, include=FALSE}
library(tidymodels)
library(cmapR)
library(magrittr)
library(gt)
library(fs)
library(purrr)
library(ggpubr)
library(tibble)
```


# logging
```{r label=tackle-logging}
MESSAGE<-T
WARNING<-T
```
# load


```{r label=tackle.load}
print(params$color)
PATH <- "."
gct_files <- fs::dir_ls(
  path = PATH,
  recurse = TRUE,
  regexp = ".gct"
 )


( gct_files )

gcts <- gct_files %>% 
purrr::map(
  cmapR::parse_gctx
)
print(gcts)

```

# funcs
```{r, label=tackle-funcs}

myzscore <- function(value, minval = NA, remask = TRUE) {
  mask <- is.na(value)
  if (is.na(minval)) minval <- min(value, na.rm = TRUE)
  value[is.na(value)] <- minval
  out <- scale(value)
  if (remask == TRUE) {
    out[mask] <- NA
  }
  return(out)
}
dist_no_na <- function(mat) {
  mat[is.na(mat)] <- min(mat, na.rm = TRUE)
  edist <- dist(mat)
  return(edist)
}
make_new_gct <- function(gct, mat){
  # make a new gct object with the same metadata as the original
  new("GCT", mat=mat,
      rid = gct@rid,
      cid=gct@cid,
      rdesc=gct@rdesc,
      cdesc=gct@cdesc,
        )
}
```


# results {.tabset}

## metadata
```{r, label='tackle.cdesc'}
gct <- gcts[[1]]
#.gct <- gcts[[1]]
#.gct@cdesc
gct@cdesc %>% 
  select(recno, runno, searchno, label, everything()) %>% 
  gt::gt(
  caption="metadata"
)

```






## metrics
```{r, label="tackle.metrics"}
gcts %>% map(
  ~cmapR::mat(.) %>% dim
)
gct <- gcts[[1]]
# all below analysis is written to analyze 1 gct object
```

## cluster


render cluster.Rmd
```{r, label=tackle-cluster, message=T, warning=T, results='show', eval=T}

.params <- params$cluster

#.params$method <- "kmeans"

render_cluster_report <- function(method="kmeans"){
  .output_file_name <- paste0("cluster_", "method_", method, ".html")
  rmarkdown::render("cluster.Rmd", 
              output_file=.output_file_name,
              params=list(method=method)
              #params=.params,
              #envir = globalenv(),
              #envir = new_env
              #documentation=1,
              )
  return(.output_file_name)
  
}
.out <- render_cluster_report(method='kmeans')
htmltools::includeHTML(.out)
# TODO: loop through all the methods 
#.out <- render_cluster_report(method='pam')
#htmltools::includeHTML(.out)
  
#htmltools::includeHTML("cluster1.html")

```




render PCA.Rmd
```{r, label=tackle-pca, message=T, warning=T, results='show', eval=T}

.params <- params$cluster

#.params$method <- "kmeans"

render_pca_report <- function(center=T, scale=F){
  .output_file_name <- paste0("PCA", "center_", center, "scale_", scale, ".html")
  rmarkdown::render("PCA.Rmd", 
              output_file=.output_file_name,
              params=list(
                center=center,
                scale=scale
              )
              #params=.params,
              #envir = globalenv(),
              #envir = new_env
              #documentation=1,
              )
  return(.output_file_name)
  
}
# TODO: allow customization
.center <- T
.scale <- T
.out <- render_pca_report(center=.center, scale=T)
htmltools::includeHTML(.out)

.out <- render_pca_report(center=.center, scale=F)
htmltools::includeHTML(.out)
## {-}

# another section


```

## YFG

```{r, label=tackle-onegene, eval=T}
.sel <- gct %>% 
  melt_gct() %>%
  filter(id.x == "928") %>%
  mutate(id.y = factor(id.y, levels=gct@cid, ordered = T)) 
 
.gene <- .sel$rdesc %>% unique
.sel %>% 
  ggpubr::ggbarplot(x='id.y', y="value",
                  title = .gene,
                  color = params$color) %>%
  ggpar(x.text.angle = 90)
```

