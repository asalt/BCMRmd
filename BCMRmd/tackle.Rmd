---
title: "tackle"
author: "AlexSaltman"
date: "`r Sys.Date()`"
output: html_document
params:
  color: "PDXModel"
  marker: "plex"
#  ROOTPATH: "`r fs::path_wd('.')`"
---

```{r tackle.setup, include=FALSE}
library(tidymodels)
library(cmapR)
library(magrittr)
library(gt)
library(fs)
library(purrr)
library(ggpubr)
library(tibble)
```


# load

```{r label=tackle.load}
print(params$color)
PATH <- "."
gct_files <- fs::dir_ls(
  path = PATH,
  recurse = TRUE,
  regexp = ".gct"
 )


( gct_files )

gcts <- gct_files %>% 
purrr::map(
  cmapR::parse_gctx
  
)

```

# funcs
```{r}

myzscore <- function(value, minval = NA, remask = TRUE) {
  mask <- is.na(value)
  if (is.na(minval)) minval <- min(value, na.rm = TRUE)
  value[is.na(value)] <- minval
  out <- scale(value)
  if (remask == TRUE) {
    out[mask] <- NA
  }
  return(out)
}
dist_no_na <- function(mat) {
  mat[is.na(mat)] <- min(mat, na.rm = TRUE)
  edist <- dist(mat)
  return(edist)
}
```


```{r, label='tackle.cdesc'}
.gct <- gcts[[1]]
.gct@cdesc %>% gt::gt()

```


```{r, label=tackle.gctlist}
print(gcts)
```



```{r, label=tackle.onegene, eval=F}
.gct <- gcts[[1]]
.sel <- .gct %>% 
  melt_gct() %>%
  filter(id.x == "928") %>%
  mutate(id.y = factor(id.y, levels=dat@cid, ordered = T)) 
 
.gene <- .sel$rdesc %>% unique
.sel %>% 
  ggpubr::ggbarplot(x='id.y', y="value",
                  title = .gene,
                  color = params$color) %>%
  ggpar(x.text.angle = 90)
```


# results {.tabset}

## metrics
```{r, label="tackle.metrics"}
gcts %>% map(
  ~cmapR::mat(.) %>% dim
)
```

## cluster

```{r, label="tackle.cluster"}
.gct <- gcts[[1]]

```

## kmeans

```{r}
# from https://www.tidymodels.org/learn/statistics/k-means/

#.tocluster <- mat(dat) 
.tocluster <- mat(.gct)
.cluster_func <- function(n, ...) kmeans(.tocluster, n, ...)

kclusts <-  tibble(n = 1:6) %>%
  mutate(
    #kclust = map(n, ~.cluster_func(n=.x)),
    kclust = map(n, ~kmeans(.tocluster,centers=.x))
  ) 
kclusts %<>% 
  mutate(
    tidied = map(kclust, tidy),
    glanced = map(kclust, glance),
    augmented = map(kclust, augment, .tocluster)
  
)
```

```{r}

clusters <- 
  kclusts %>%
  unnest(cols = c(tidied))

assignments <- 
  kclusts %>% 
  unnest(cols = c(augmented))

clusterings <- 
  kclusts %>%
  unnest(cols = c(glanced))
```


```{r}
ggplot(clusterings, aes(n, tot.withinss)) +
  geom_line() +
  geom_point() +
  scale_x_discrete(limits=seq(1, 9,1) %>% as.factor() )
  #scale_x_discrete(limits=breaks_pretty())
  #ggpubr::theme_pubclean()
  #breaks_pretty() +
```


```{r}

ComplexHeatmap::Heatmap(
  mat(.gct) %>% head(30)
)

```

## pca
```{r, label="tackle.PCA"}
# from https://www.bioconductor.org/packages/release/bioc/vignettes/PCAtools/inst/doc/PCAtools.html#conduct-principal-component-analysis-pca
library(PCAtools)
print('pca')
.p <- PCAtools::pca(
  mat(.gct) ,
  metadata = .gct@cdesc
)
```

```{r}
screeplot(.p, axisLabSize = 18, titleLabSize = 22, components = 1:10)

```

```{r}
biplot(.p)

```

```{r}
.p %>%  pairsplot()
```
```{r}
.p %>% plotloadings(labSize = 3)

```


```{r}
# not sure what this means for non-numeric
.p %>% eigencorplot(
  metavars = c(
    "SampleType",
    "OrganSite",
    "PDXModel",
    #"plex"
  )
)
```

## {-}

# another section

